version: '3.9'

networks:
  default:
    name: synology

volumes:
  traefik:
    name: traefik

services:
  cf-companion:
    image: docker.io/tiredofit/traefik-cloudflare-companion
    container_name: cf-companion
    restart: unless-stopped
    network_mode: host
    security_opt:
      - no-new-privileges:true
    logging:
      driver: local
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TRAEFIK_VERSION=2
      - REFRESH_ENTRIES=true
      - CF_EMAIL
      - CF_TOKEN
      - TARGET_DOMAIN
      - DOMAIN1=${DOMAIN}
      - DOMAIN1_ZONE_ID=${CF_ZONE_ID}
      - DOMAIN1_PROXIED=FALSE

  dockergc:
    image: docker.io/clockworksoul/docker-gc-cron
    container_name: docker-gc
    network_mode: host
    logging:
      driver: local
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      CRON: 30 4 * * * # https://cron.help/#30_4_*_*_*
      FORCE_IMAGE_REMOVAL: 1
      FORCE_CONTAINER_REMOVAL: 0
      GRACE_PERIOD_SECONDS: 604800 # 7 days
      DRY_RUN: 0
      CLEAN_UP_VOLUMES: 1

  plex:
    image: ghcr.io/hotio/plex
    container_name: plex
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    network_mode: host
    logging:
      driver: local
    environment:
      - PUID
      - PGID
      - VERSION=docker
      - PLEX_CLAIM
      - PLEX_PASS
    devices:
      - /dev/dri:/dev/dri
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${PLEX_CONF}:/config
      - ${PLEX_PLUGINS}:/Library/Application Support/Plex Media Server/Plug-ins
      - ${MEDIA}:/media
      - ${TRANSCODE}:/transcode
    labels:
      traefik.enable: 'true'
      # HTTP Routers
      traefik.http.routers.plex.entrypoints: https
      traefik.http.routers.plex.rule: Host(`plex.${DOMAIN}`)
      traefik.http.routers.plex.tls: 'true'
      # Services
      traefik.http.routers.plex.service: plex
      traefik.http.services.plex.loadbalancer.server.port: 32400
      traefik.http.routers.plex.tls.certresolver: letsencrypt
      # Watchtower
      com.centurylinklabs.watchtower.enable: 'true'

  plex-trakt-sync:
    image: ghcr.io/taxel/plextraktsync
    container_name: plex-trakt-sync
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    network_mode: host
    logging:
      driver: local
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${APP_CONF}/plex/trakt-sync/:/app/config/
    command: watch

  traefik:
    image: docker.io/traefik:v2.5
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    network_mode: host
    logging:
      driver: local
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - traefik:/acme
    command:
      # Disable certain settings
      - --global.checkNewVersion=false
      - --global.sendAnonymousUsage=false
      # Enable logging
      - --log=true
      - --log.level=WARN
      - --accessLog=true
      # Enable API & Dashboard
      - --api=true
      - --api.dashboard=true
      # Configure Docker provider
      - --providers.docker=true
      - --providers.docker.swarmMode=false
      - --providers.docker.exposedbydefault=false
      # Configure entrypoints (HTTP & HTTPS)
      - --entrypoints.http.address=:80
      - --entrypoints.https.address=:443
      - --entryPoints.traefik.address=:8080
      # Set up the TLS configuration for HTTPS
      - --entrypoints.https.http.tls.certresolver=letsencrypt
      - --entrypoints.https.http.tls.domains[0].main=$DOMAIN
      - --entrypoints.https.http.tls.domains[0].sans=*.$DOMAIN
      # Configure LetsEncrypt
      - --certificatesResolvers.letsencrypt.acme.email=${CF_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesResolvers.letsencrypt.acme.dnsChallenge.provider=cloudflare
      - --certificatesResolvers.letsencrypt.acme.dnsChallenge.resolvers=1.1.1.1:53,1.0.0.1:53
      - --certificatesResolvers.letsencrypt.acme.dnsChallenge.delayBeforeCheck=90
      - --certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json
    labels:
      traefik.enable: 'true'
      traefik.docker.network: public
      # HTTP-to-HTTPS Redirect
      traefik.http.routers.http_catchall.rule: HostRegexp(`{any:.+}`)
      traefik.http.routers.http_catchall.entrypoints: http
      traefik.http.routers.http_catchall.middlewares: https_redirect
      traefik.http.routers.traefik.rule: Host(`nas.${DOMAIN}`)
      # HTTP Routers
      traefik.http.routers.traefik.entrypoints: https
      traefik.http.routers.traefik.tls: 'true'
      traefik.http.routers.traefik.tls.certresolver: letsencrypt
      # Services - API
      traefik.http.routers.traefik.service: api@internal
      # Middlewares
      traefik.http.middlewares.https_redirect.redirectscheme.scheme: https
      traefik.http.middlewares.https_redirect.redirectscheme.permanent: 'true'

  watchtower:
    image: docker.io/containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    network_mode: host
    security_opt:
      - no-new-privileges:true
    logging:
      driver: local
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      WATCHTOWER_LABEL_ENABLE: 'true'
      WATCHTOWER_CLEANUP: 'true'
      WATCHTOWER_REMOVE_VOLUMES: 'true'
      WATCHTOWER_INCLUDE_STOPPED: 'true'
      WATCHTOWER_INCLUDE_RESTARTING: 'true'
      WATCHTOWER_NO_STARTUP_MESSAGE: 'false'
      WATCHTOWER_SCHEDULE: '30 5 * * * *' # Everyday at 5:30AM
      WATCHTOWER_NOTIFICATIONS_LEVEL: info
      DOCKER_API_VERSION: '1.39'
    labels:
      com.centurylinklabs.watchtower.enable: 'true'
